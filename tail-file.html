<script type="text/x-red" data-template-name="tail-file">
    <div class="form-row">
        <label for="node-input-filename"><i class="fa fa-file"></i> Filename</label>
        <input type="text" id="node-input-filename">
    </div>

    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-createFile" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-createFile" style="width: 70%;"><span>Create File if not exists</span></label>
    </div>

    <div class="form-row">
        <label for="node-input-mode"><i class="fa fa-random"></i> Mode</label>
        <select id="node-input-mode" style="width: 150px;">
            <option value="">Normal</option>
            <option value="replaced">Rewritable&nbsp;file</option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-encoding"><i class="fa fa-font"></i> Encoding</label>
        <select id="node-input-encoding" style="width: 150px;">
            <option value="utf-8">utf8&nbsp;/&nbsp;utf-8</option>
            <option value="ucs2">ucs2&nbsp;/&nbsp;ucs-2</option>
            <option value="utf16le">utf16le&nbsp;/&nbsp;utf-16le</option>
            <option value="latin1">latin1</option>
            <option value="base64">base64</option>
            <option value="ascii">ascii</option>
            <option value="hex">hex</option>
            <option value="binary">binary (>Buffer)</option>
        </select>
    </div>

    <div class="form-row" id="node-tail-file-separator">
        <label for="node-input-separator"><i class="fa fa-code"></i> Split</label>
        <input type="checkbox" id="node-input-split" style="display: inline-block; width: auto; margin: auto;">
        <label for="node-input-split" style="width: auto;"><span style="vertical-align: middle;">Use separator:&nbsp;</span></label>
        <input type="text" id="node-input-separator" placeholder="[\r]{0,1}\n" style="width: 160px;">
    </div>

    <div class="form-row">
        <label><i class="fa fa-bars"></i><span> Optional</span></label>
        <input type="checkbox" id="node-input-fromBeginning" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-fromBeginning" style="width: 70%;"><span>From beginning</span></label>
    </div>

    <div class="form-row" id="node-tail-file-flush">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-flushAtEOF" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-flushAtEOF" style="width: 70%;"><span>Flush at EOF</span></label>
    </div>

    <div class="form-row" id="node-tail-file-remember">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-rememberLast" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-rememberLast" style="width: 70%;"><span>Try to remember the last entry</span></label>
    </div>

    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-limitSize" style="display: inline-block; width: auto; margin: auto;">
        <label for="node-input-limitSize" style="width: auto;"><span style="vertical-align: middle;">Maximum in one read:&nbsp;</span></label>
        <input type="number" min="1" id="node-input-maxBytes" placeholder="5120" style="width: 70px; height: 28px;">
        <label for="node-input-limitSize" style="width: auto;"><span style="vertical-align: middle;">&nbsp;bytes</span></label>
    </div>

    <div class="form-row" id="node-tail-file-blank">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-skipBlank" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-skipBlank" style="width: 70%;"><span>Skip blank entries</span></label>
    </div>

    <div class="form-row" id="node-tail-file-trim" style="display: block;">
        <label>&nbsp;</label>
        <label style="width: 15px;" label=""></label>
        <input type="checkbox" id="node-input-useTrim" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-useTrim" style="width: 65%;"><span>Use .trim() to check for blank entries</span></label>
    </div>

    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-sendError" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-sendError" style="width: 70%;"><span>Send message on error (legacy mode)</span></label>
    </div>

    <div class="form-row">
        <label for="node-input-interval"><i class="fa fa-refresh"></i> Interval</label>
        <input type="number" min="1" id="node-input-interval" placeholder="200" style="width: 70px;">
        &nbsp;<span>milliseconds</span>
    </div>


    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>


    <div class="form-row" id="node-tail-file-debug">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-debug" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-debug" style="width: 70%;"><span>debug</span></label>
    </div>
</script>

<script type="text/x-red" data-help-name="tail-file">
    <p>Tails (watches for things to be added) to the configured file.</p>

    <ul>
        <li>Binary entries (<i>Encoding: binary</i>) will be returned as Buffer objects.</li>
        <li>Text entries will be returned as strings.</li>
    </ul>

    <h3>Details</h3>
        <p>More info can be found on <a href="https://github.com/Izdatyi/node-red-contrib-tail-file#node-red-contrib-tail-file" target="_blank">GitHub</a> repository</p>

    <h3>Inputs</h3>
        <dl class="message-properties">
            <dt>topic <span class="property-type">string</span></dt>
            <dd> command</dd>

            <dt class="optional">payload <span class="property-type">string | JSON</span></dt>
            <dd> parameters for command</dd>
        </dl>

    <h3>Outputs</h3>
        <ol class="node-ports">
            <li>Standard output
                <dl class="message-properties">
                    <dt>payload <span class="property-type">string</span></dt>
                    <dd>entry</dd>
                </dl>
    
                <dl class="message-properties">
                    <dt>topic <span class="property-type">string</span></dt>
                    <dd>the path to the file</dd>
                </dl>
            </li>
    
            <li>Standard error
                <dl class="message-properties">
                    <dt>filename <span class="property-type">string</span></dt>
                    <dd>the path to the file</dd>
                </dl>
    
                <dl class="message-properties">
                    <dt>error <span class="property-type">string</span></dt>
                    <dd><i>deprecated</i>: If enabled in the node, when the node hits an error
                    reading the file, it will send a message with no <code>payload</code>
                    and this <code>error</code> property set to the error details. This
                    mode of behaviour is deprecated and not enabled by default for new
                    instances of the node. See below for more information.</dd>
                </dl>
            </li>
        </ol>

    <h3>Usage</h3>
        <p><b>stop</b> tail:
        <pre>{  "topic": "tail-file-stop"   }</pre>

        <p><b>start</b> tail:
        <pre>{  "topic": "tail-file-start"  }</pre>

        <p><b>change</b> filename:
        <pre>{
    "topic": "tail-file-filename",
    "payload": "c:/new_file.log"
}</pre>

        <p>full <b>config</b> parameters (<i>default</i>):
    <pre>{
    "topic": "tail-file-config",
    "payload": {
        "filename": "",
        "createFile": false,
        "mode": "",
        "encoding": "utf-8",
        "split": true,
        "separator": "[\r]{0,1}\n",
        "fromBeginning": false,
        "flushAtEOF": false,
        "rememberLast": true,
        "lineBytes": 512,
        "limitSize": true,
        "maxBytes": 5120,
        "skipBlank": true,
        "useTrim": true,
        "sendError": false,
        "interval": 100,
        
        "chokidar": {
            "persistent": true,
            "ignoreInitial": true,
            "usePolling": true,
            "interval": 100,
            "binaryInterval": 300,
            "alwaysStat": true,
            "awaitWriteFinish": {
                "stabilityThreshold": 200,
                "pollInterval": 100
            },
            "ignorePermissionErrors": true,
            "atomic": true
        }
    }
}</pre>

    <p>"Rewritable file" <b>mode</b>:
    <pre>{
    "topic": "tail-file-config",
    "payload": {
        "filename": "",
        "mode": "replaced",
        "split": false,
        "fromBeginning": false,
        "rememberLast": true,
        "lineBytes": 512,
        "limitSize": true,
        "maxBytes": 5120,
        "skipBlank": false,
        "useTrim": false,
        "interval": 200
    }
}</pre>

    <p>changing <a href="https://github.com/paulmillr/chokidar#performance" target="_blank"><b>chokidar</b></a> parameters only:
    <pre>{
    "topic": "tail-file-config",
    "payload": {
        "chokidar": {
            "usePolling": true,
            "awaitWriteFinish": {
                "stabilityThreshold": 350
            },
            "ignorePermissionErrors": true
        }
    }
}</pre>

    <p><b>reset</b> / <b>revert</b> all parameters to <i>default</i>:
    <pre>{
    "topic": "tail-file-config",
    "payload": {}
}</pre>

</script>

<script type="text/javascript">
    RED.nodes.registerType('tail-file', {
        category: 'storage-input',
        defaults: {
            debug: { value: true },
            filename: { value: "e:/www.txt" },    // e:/www.txt
            createFile: { value: false },
            mode: { value: "" },
            encoding: { value: "utf-8" },
            split: { value: true },
            separator: { value: "" },
            fromBeginning: { value: false },
            flushAtEOF: { value: false },
            rememberLast: { value: true },
            limitSize: { value: true },
            maxBytes: { value: "" },
            skipBlank: { value: true },
            useTrim: { value: true },
            sendError: { value: false },
            interval: { value: "" },
            name: { value: "" }
        },
        color: "burlywood",
        inputLabels: "parameters for input",
        inputs: 1,
        outputs: 1,
        icon: "file.png",
        label: function () {
            return this.name || this.filename || "tail file";
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            $("#node-input-split").change(function () {
                $("#node-input-separator").attr('disabled', !$("#node-input-split").prop('checked'));
            })
            $("#node-input-mode").on("change", function () {
                if (this.value === "") {
                    $("#node-tail-file-flush").show();
                    $("#node-tail-file-remember").hide();
                    $('#node-input-interval').attr('placeholder', '100');
                } else {
                    $("#node-tail-file-flush").hide();
                    $("#node-tail-file-remember").show();
                    $('#node-input-interval').attr('placeholder', '200');
                }
            });
            $("#node-input-encoding").on("change", function () {
                if (this.value === "binary") {
                    $("#node-tail-file-separator").hide();
                    // $("#node-tail-file-blank").hide();
                    $("#node-tail-file-trim").hide();
                }
                else {
                    $("#node-tail-file-separator").show();
                    // $("#node-tail-file-blank").show();
                    if ($("#node-input-skipBlank").prop('checked') === true) {
                        $("#node-tail-file-trim").show();
                    } else {
                        $("#node-tail-file-trim").hide();
                    }
                }
            });
            $("#node-input-limitSize").change(function () {
                $("#node-input-maxBytes").attr('disabled', !$("#node-input-limitSize").prop('checked'));
            })
            $("#node-input-skipBlank").on("change", function () {
                if ((this.checked === true) && !($("#node-input-encoding").prop('value') === "binary")) {
                    $("#node-tail-file-trim").show();
                } else {
                    $("#node-tail-file-trim").hide();
                }
            });
        }
    });
</script>
